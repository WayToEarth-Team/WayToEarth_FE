# WayToEarth Study Log — 2025-10-09

본 문서는 오늘 진행한 Swagger 분석, 크루 API 실서버 연동, 채팅 초기 로딩, EAS 빌드 가이드, 카카오 해시 키 추출 등 핵심 내용을 실무 관점에서 정리한 자료입니다.

## 오늘의 목표
- Swagger 스펙 기반으로 크루 관련 API를 정확히 매핑하고 기존 목 로직 제거
- 채팅 최근 메시지 REST 연동 및 소켓 구조 점검
- EAS 빌드 수행을 위한 환경/시크릿/프로필 점검과 해시 키 추출 절차 정리

## Swagger 분석 요약 (Crew)
- 주요 태그: Crew Management, Crew Member Management, Crew Join Management, Crew Statistics, 크루 채팅
- 대표 엔드포인트
  - 목록/검색: GET `/v1/crews`, GET `/v1/crews/search?keyword=`
  - 내 크루: GET `/v1/crews/my` (Page)
  - 상세: GET `/v1/crews/{crewId}`
  - 멤버: GET `/v1/crews/{crewId}/members`, DELETE `/v1/crews/{crewId}/members/{userId}`
  - 가입: POST `/v1/crews/{crewId}/join-requests`, GET `/v1/crews/{crewId}/join-requests`
  - 승인/거절: POST `/v1/crews/join-requests/{requestId}/approve|reject` (body: `{ note?: string }`)
  - 역할 변경: PATCH `/v1/crews/{crewId}/members/{userId}/role` (body: `{ newRole: "MEMBER" }`)
  - 소유권 이양: POST `/v1/crews/{crewId}/transfer-ownership` (body: `{ newOwnerId }`)
  - 탈퇴/폐쇄: DELETE `/v1/crews/{crewId}/members/leave`, DELETE `/v1/crews/{crewId}`
  - 채팅 최근: GET `/v1/crews/{crewId}/chat/messages/recent?limit=`

실무 포인트: 서버 스키마에서 OWNER/MEMBER 체계 → 프론트 UI의 ADMIN/MEMBER에 맞추어 OWNER를 ADMIN으로 매핑하여 일관성 유지.

## 적용한 코드 변경
- 설정
  - `app.config.js`: `extra.crewMockEnabled = false`로 실서버 연동 사용
- API 클라이언트
  - `utils/api/crews.ts`: Swagger에 맞춰 모든 엔드포인트/타입 매핑 재구성
    - `getMyCrew()`: `/v1/crews/my` 페이지 응답에서 첫 항목을 UI용 `Crew`로 변환
    - `getMyCrewDetail()`: 상세/멤버/가입요청 3개 호출 결합, OWNER→ADMIN 매핑
    - `listCrews()`/`searchCrews()`: 페이지네이션 응답을 UI 카드 타입으로 변환
    - `joinCrew()`: `/join-requests` POST로 변경, 기본 `pending` 흐름 반영
    - `removeMember/approve/reject/promote/demote/close/leave/transferOwnership`: 모두 Swagger 경로/바디로 치환
  - `utils/api/crewChat.ts` 추가: `getRecentCrewMessages()` 구현
  - `utils/api/index.ts`: `export * from "./crews";` 추가
- 화면 로직
  - `Pages/CrewDetailScreen.tsx`: 변경된 시그니처에 맞게 `crewId` 전달
  - `Pages/CrewChatScreen.tsx`: REST로 최근 메시지 받아 `useCrewChat` seed 제공
- 실시간
  - `utils/realtime/socket.ts`: `socket.io-client` 사용, `/socket.io` 경로, JWT Bearer 인증

## 중요한 실무 개념/주의점
- 응답 언래핑: 서버가 `{ success, data }` 래퍼를 주는 경우 Axios 인터셉터에서 `res.data = data`로 통일 → 하위 코드 단순화
- 권한 매핑: 서버 `OWNER` ↔ UI `ADMIN` 매핑 정책을 한 곳에서 일관되게 적용 (멤버 리스트/내 역할/버튼 노출 모두 영향)
- 페이지네이션: 목록 API는 Page 형태 → `content`만 쓰되, 필요 시 `totalElements/number/size`도 보존 가능
- 환경 분리: `EXPO_PUBLIC_API_BASE_URL`로 환경 스위칭; 로컬/스테이징/운영 분리 필수
- 비밀정보: `.env`/EAS Secrets 사용, 레포에 커밋 금지
- 실패 대응: API 에러 로깅 최소화(PII 제외), 사용자 메시지는 친절하게, 재시도 간격/정책 설계

## 코드 스니펫

### Axios 클라이언트 인터셉터 (응답 언래핑)
`utils/api/client.ts`
```ts
client.interceptors.response.use((res) => {
  const d = res.data;
  if (d && typeof d === "object" && "data" in d && ("success" in d || "message" in d)) {
    res.data = (d as any).data; // 이후 .data가 실제 페이로드
  }
  return res;
});
```

### 내 크루 조회 매핑
`utils/api/crews.ts`
```ts
export async function getMyCrew(): Promise<Crew | null> {
  const { data } = await client.get("/v1/crews/my", { params: { page: 0, size: 1 } });
  const first = (data as any)?.content?.[0];
  if (!first) return null;
  return {
    id: String(first.id),
    name: String(first.name ?? "크루"),
    description: String(first.description ?? ""),
    progress: `${first.currentMembers ?? 0}/${first.maxMembers ?? 0}`,
    imageUrl: first.profileImageUrl ?? null,
  };
}
```

### 가입 신청 생성 (승인 대기 흐름)
```ts
export async function joinCrew(crew: Crew, message?: string): Promise<JoinResult> {
  await client.post(`/v1/crews/${crew.id}/join-requests`, { message: message ?? "" });
  return { pending: true, crewId: crew.id };
}
```

### 소유권 이양/역할 변경
```ts
export async function transferOwnership(crewId: string, userId: string) {
  await client.post(`/v1/crews/${crewId}/transfer-ownership`, { newOwnerId: Number(userId) });
}
export async function demoteMember(crewId: string, userId: string) {
  await client.patch(`/v1/crews/${crewId}/members/${userId}/role`, { newRole: "MEMBER" });
}
```

### 채팅 최근 메시지 로드 + 훅 시딩
`utils/api/crewChat.ts`
```ts
export async function getRecentCrewMessages(crewId: string, limit = 20) {
  const { data } = await client.get(`/v1/crews/${crewId}/chat/messages/recent`, { params: { limit } });
  return (data ?? []) as CrewChatMessage[];
}
```
`Pages/CrewChatScreen.tsx`
```ts
useEffect(() => {
  (async () => {
    const recent = await getRecentCrewMessages(crewId, 30);
    const mapped: ChatMessage[] = (recent || []).map((m) => ({
      id: String(m.messageId),
      text: String(m.message ?? ""),
      createdAt: m.sentAt ? new Date(m.sentAt).getTime() : Date.now(),
      userId: String(m.senderId),
      nickname: String(m.senderName ?? ""),
      role: "MEMBER",
    }));
    setSeed(mapped);
  })();
}, [crewId]);
```

### 소켓 연결(선택)
`utils/realtime/socket.ts`
```ts
const socket = io.io(url, {
  path: "/socket.io",
  transports: ["websocket"],
  auth: { token: token ? `Bearer ${token}` : undefined },
});
```

## EAS 빌드 가이드 (요약)
- 로그인/초기화: `npx eas login`, `npx eas init -p all`
- 시크릿 등록(예):
  - `npx eas secret:create --name EXPO_PUBLIC_API_BASE_URL --value https://waytoearth.cloud`
  - 맵/카카오 키도 동일 방식 등록
- 개발 빌드: `npx eas build -p ios --profile development`, `npx eas build -p android --profile development`
- 프리뷰/프로덕션: `--profile preview|production`
- Dev Client 실행: `npx expo start --dev-client`

## 카카오 안드로이드 해시 키 추출 팁
- EAS Keystore 사용(권장):
```
keytool -exportcert -alias <alias> -keystore <keystore> -storepass <storePass> -keypass <keyPass> \
| openssl sha1 -binary | openssl base64
```
- SHA-1(Fingerprint) → Base64 변환:
```
HEX="AA:BB:CC:...:FF" && echo $HEX | sed 's/://g' | xxd -r -p | openssl base64
```
- 로컬 디버그 키:
```
keytool -exportcert -alias androiddebugkey -keystore ~/.android/debug.keystore -storepass android -keypass android \
| openssl sha1 -binary | openssl base64
```

## 다음 할 일
- 서버 소켓 이벤트/인증 스펙 확정 시 `useCrewChat` 이벤트 바인딩 고도화 (읽음 처리/배치 읽음 연동)
- 크루 통계/랭킹 화면 API 연동 (Statistics 태그)
- 에러/로딩 UX 손보기, 공통 토스트/다이얼로그 정리

---
실무 가이드 요약: 스펙 우선 정합성, 응답/타입 표준화, 환경/시크릿 분리, 권한 체계 일관성, 페이지네이션/에러 UX 고려가 핵심입니다.

